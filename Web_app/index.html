<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel ABSA Intelligence Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>

    <style>
        /* ================= VARIABLES ================= */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-primary: #f0f4f8;
            --bg-card: rgba(255, 255, 255, 0.95);
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --border-color: rgba(102, 126, 234, 0.15);
            --shadow-glow: 0 10px 40px rgba(102, 126, 234, 0.12);
            --color-positive: #39ff14; 
            --color-neutral: #8c93a8;
            --color-negative: #ef4444; 
            --color-neon-blue: #00f2ff;
        }

        /* ================= BASE STYLES ================= */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background: 
                radial-gradient(ellipse at top left, rgba(102, 126, 234, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(118, 75, 162, 0.08) 0%, transparent 50%),
                linear-gradient(180deg, #f0f4f8 0%, #e8eef5 50%, #f5f7fa 100%);
            background-attachment: fixed;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 60px;
        }

        .main-container { max-width: 1400px; margin: 0 auto; padding: 20px 24px; }

        /* ================= UI COMPONENTS ================= */
        .top-nav {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 24px; background: var(--bg-card); backdrop-filter: blur(20px);
            border-radius: 16px; border: 1px solid var(--border-color);
            margin-bottom: 24px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
        }
        .logo-section { display: flex; align-items: center; gap: 14px; }
        .logo-icon {
            width: 44px; height: 44px; border-radius: 12px; background: var(--primary-gradient);
            display: flex; align-items: center; justify-content: center; font-size: 22px; 
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .logo-text {
            font-weight: 700; font-size: 20px;
            background: linear-gradient(135deg, #1a202c 0%, #4a5568 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .nav-badge {
            background: var(--primary-gradient); color: white; font-size: 10px; font-weight: 700; 
            padding: 4px 10px; border-radius: 20px; text-transform: uppercase;
        }

        .hero-card {
            background: var(--bg-card); backdrop-filter: blur(20px); border-radius: 24px; 
            padding: 48px 40px; border: 1px solid var(--border-color);
            box-shadow: var(--shadow-glow); margin-bottom: 32px; position: relative; overflow: hidden;
        }
        .hero-card::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--primary-gradient);
        }
        .hero-title {
            font-size: 42px; font-weight: 800; line-height: 1.15; margin-bottom: 16px;
            background: linear-gradient(135deg, #1a202c 0%, #667eea 50%, #764ba2 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        /* ================= TABS & INPUT ================= */
        .input-wrapper {
            background: white; border-radius: 16px; border: 1px solid #e2e8f0; 
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06); overflow: hidden;
        }
        .tabs {
            display: flex; justify-content: flex-start; gap: 10px; padding: 12px 20px 0; 
            background: #f8fafc; border-bottom: 1px solid #e2e8f0;
        }
        .tab-btn {
            flex: 0 0 auto; padding: 10px 20px; border: 1px solid transparent; background: transparent;
            font-weight: 600; font-size: 13px; color: #64748b; cursor: pointer; 
            border-radius: 8px 8px 0 0; margin-bottom: -1px;
        }
        .tab-btn.active {
            background: white; color: #4f46e5; border-color: #e2e8f0; border-bottom-color: white; 
        }

        .input-content { padding: 24px; }
        
        textarea {
            width: 100%; height: 120px; padding: 16px; border: 1px solid #cbd5e1; border-radius: 12px;
            font-family: inherit; font-size: 15px; resize: vertical; outline: none; display: block;
        }
        textarea:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12); }

        .upload-zone {
            border: 2px dashed #cbd5e1; border-radius: 12px; padding: 30px 24px; text-align: center; 
            cursor: pointer; transition: all 0.2s; background: #f8fafc; display: none; 
        }
        .upload-zone.active { display: block; }
        .upload-zone:hover { border-color: #6366f1; background: #eff6ff; }
        
        .file-info { margin-top: 10px; color: #4f46e5; font-weight: 600; display: none;}

        .btn-primary { 
            padding: 12px 28px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer;
            background: linear-gradient(135deg, #7c3aed 0%, #6366f1 100%); color: white; 
            margin-top: 16px; float: right; 
        }

        /* ================= GRID & RESULTS ================= */
        .result-grid {
            display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; 
            margin-top: 32px; display: none;
        }
        .col-span-2 { grid-column: span 2; }
        .col-span-5 { grid-column: span 5; }
        .col-span-6 { grid-column: span 6; }
        .col-span-12 { grid-column: span 12; }

        .result-card {
            background: var(--bg-card); border-radius: 20px; padding: 24px;
            border: 1px solid var(--border-color); height: 100%; display: flex; flex-direction: column;
        }
        .dark-card { background: #0f172a; color: #e5e7eb; border: none; }
        
        .card-header { 
            display: flex; align-items: center; gap: 12px; margin-bottom: 20px; 
            border-bottom: 1px solid rgba(102, 126, 234, 0.15); padding-bottom: 12px; flex-shrink: 0;
        }
        .card-icon { 
            width: 40px; height: 40px; border-radius: 10px; display: flex; 
            align-items: center; justify-content: center; font-size: 20px; background: rgba(102, 126, 234, 0.2); 
        }

        /* Charts & Tables */
        .score-container { display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .score-big { font-size: 38px; font-weight: 800; margin: 10px 0; color: #fff; }
        
        .bar-chart-row { display: flex; align-items: center; margin-bottom: 16px; }
        .bar-label { width: 90px; font-size: 13px; font-weight: 600; color: #e5e7eb; text-align: right; padding-right: 12px; }
        .bar-track { flex-grow: 1; height: 24px; background: #1e293b; border-radius: 20px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--color-neon-blue); border-radius: 20px; transition: width 1s ease-out; }
        .bar-value { margin-left: 10px; font-weight: bold; width: 35px; font-size: 13px; color: #e5e7eb; }

        .donut { width: 220px; height: 220px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: conic-gradient(#8c93a8 0% 100%); }
        .donut-hole { width: 160px; height: 160px; background: #0f172a; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .polarity-flex-container { display: flex; align-items: center; justify-content: center; gap: 30px; height: 100%; min-height: 240px; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
        th { text-align: left; padding: 12px 14px; background: rgba(102, 126, 234, 0.15); color: var(--text-primary); font-weight: 700; }
        td { padding: 12px 14px; border-bottom: 1px solid var(--border-color); color: #020617; font-weight: 600; word-wrap: break-word; vertical-align: top; }
        .dark-card table td { color: #e5e7eb; font-weight: normal; }

        .wordcloud-wrapper { width: 100%; height: 350px; position: relative; flex-grow: 1; overflow: hidden; display: flex; align-items: center; justify-content: center; }

        @media (max-width: 1024px) {
            .col-span-2 { grid-column: span 12; display: flex; align-items: center; justify-content: space-between; padding: 20px 40px;}
            .col-span-5 { grid-column: span 6; }
        }
        @media (max-width: 768px) {
            .result-grid { grid-template-columns: 1fr; }
            .col-span-2, .col-span-5, .col-span-6, .col-span-12 { grid-column: span 1; }
            table { min-width: 700px; }
            .col-span-12 { overflow-x: auto; }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <nav class="top-nav">
            <div class="logo-section">
                <div class="logo-icon">üè®</div>
                <span class="logo-text">Hotel ABSA Intelligence</span>
            </div>
            <div class="nav-badge">AI Powered v2.0</div>
        </nav>

        <header class="hero-card">
            <h1 class="hero-title">Hotel Aspect Based<br>Sentiment Analysis Engine</h1>
        </header>

        <main>
            <section class="input-wrapper">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="text">üìù Input Single Review</button>
                    <button class="tab-btn" data-tab="file">üìÇ File Upload (CSV/Excel/TXT)</button>
                </div>

                <div class="input-content">
                    <div id="textSection">
                        <textarea id="reviewInput" placeholder="Enter your review here...">I had a great experience staying at this hotel, where the atmosphere felt warm and welcoming from the moment I arrived. The rooms were clean, comfortable, and well-equipped, making it easy to relax after a long day. The staff were attentive and friendly, ensuring every part of my stay was smooth and enjoyable.</textarea>
                    </div>

                    <div id="uploadSection" class="upload-zone">
                        <input type="file" id="fileInput" accept=".csv, .xlsx, .txt" style="display: none;">
                        <div style="font-size: 40px; margin-bottom: 10px;">‚òÅÔ∏è</div>
                        <div style="color: #475569; font-weight: 500;">Click to Browse or Drag File Here</div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">
                            Supported formats: CSV, XLSX, TXT
                        </div>
                        <div id="fileInfo" class="file-info">Selected: <span id="fileName"></span></div>
                        
                        <!-- Format Instructions -->
                        <div style="background: rgba(102, 126, 234, 0.08); border: 1px solid rgba(102, 126, 234, 0.2); border-radius: 12px; padding: 16px 20px; margin-top: 20px; text-align: left;">
                            <div style="font-weight: 600; color: #667eea; font-size: 13px; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                                <span>üìã</span> File Format Requirements
                            </div>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 12px; font-size: 12px; color: #4a5568; line-height: 1.7;">
                                <div style="font-weight: 600; color: #667eea;">üìä CSV/Excel:</div>
                                <div>
                                    ‚Ä¢ Each row represents one review<br>
                                    ‚Ä¢ Encoding: UTF-8 recommended
                                </div>
                                
                                <div style="font-weight: 600; color: #667eea;">üìÑ TXT:</div>
                                <div>
                                    ‚Ä¢ One review per line<br>
                                    ‚Ä¢ Empty lines will be ignored<br>
                                    ‚Ä¢ Encoding: UTF-8 required
                                </div>                   
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                        <button class="btn-primary" style="background: #e2e8f0; color: #475569;" id="btnClear">Clear</button>
                        <button class="btn-primary" id="btnAnalyze">Analyze Insights</button>
                    </div>
                </div>
            </section>

            <div class="result-grid">
                <div class="result-card dark-card col-span-2">
                    <div class="score-container">
                        <div style="font-size: 11px; text-transform: uppercase; color: #cbd5e1; font-weight: 600;">Overall Sentiment Score</div>
                        <div class="score-big">0.0/10</div>
                        <div style="font-size: 13px; color: #94a3b8;">Dominant: <span id="dominantText">-</span></div>
                    </div>
                </div>
                <div class="result-card dark-card col-span-5">
                    <div class="card-header" style="border-bottom-color: rgba(255,255,255,0.1)">
                        <div class="card-icon">üìä</div>
                        <div style="font-weight: 700; font-size: 18px;">Category Score (0-1)</div>
                    </div>
                    <div class="chart-container-bar" style="padding: 10px 0;"></div>
                </div>
                <div class="result-card dark-card col-span-5">
                    <div class="card-header" style="border-bottom-color: rgba(255,255,255,0.1); margin-bottom: 0;">
                        <div class="card-icon">ü•ß</div>
                        <div style="font-weight: 700; font-size: 18px;">Polarity Distribution</div>
                    </div>
                    <div class="polarity-flex-container">
                        <div class="donut"><div class="donut-hole"><span style="font-size: 28px; font-weight: bold; color: #39ff14;">0%</span></div></div>
                        <div class="pie-legend">
                            <div><span style="color:#39ff14">‚óè</span> Positive</div>
                            <div><span style="color:#8c93a8">‚óè</span> Neutral</div>
                            <div><span style="color:#ef4444">‚óè</span> Negative</div>
                        </div>
                    </div>
                </div>
                <!-- WORDCLOUD MOVED BEFORE STATISTICS -->
                <div class="result-card dark-card col-span-6">
                    <div class="card-header" style="border-bottom-color: rgba(255,255,255,0.1)"><div class="card-icon">üî§</div><div style="font-weight: 700;">Top Terms</div></div>
                    <div class="wordcloud-wrapper"><canvas id="termCanvas"></canvas></div>
                </div>
                <div class="result-card dark-card col-span-6">
                    <div class="card-header" style="border-bottom-color: rgba(255,255,255,0.1)"><div class="card-icon">üí¨</div><div style="font-weight: 700;">Top Opinions</div></div>
                    <div class="wordcloud-wrapper"><canvas id="opinionCanvas"></canvas></div>
                </div>
                <!-- STATISTICS NOW AFTER WORDCLOUD -->
                <div class="result-card col-span-12">
                    <div class="card-header"><div class="card-icon">üìä</div><div style="font-weight: 700;">Statistics</div></div>
                    <table id="statsTable"><thead><tr><th>Category</th><th>Total</th><th>Positive</th><th>Neutral</th><th>Negative</th><th>Avg Score</th></tr></thead><tbody></tbody></table>
                </div>
                <div class="result-card col-span-12">
                    <div class="card-header"><div class="card-icon">üìã</div><div style="font-weight: 700;">Detailed Analysis</div></div>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table id="detailedTable"><thead><tr><th>Clause</th><th>Term</th><th>Opinion</th><th>Category</th><th>Category Score</th><th>Polarity</th><th>Polarity Score</th><th>Original</th></tr></thead><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // CONFIGURATION
        const BASE_URL = "http://localhost:8000"; 
        const ANALYZE_URL = `${BASE_URL}/analyze`;
        const UPLOAD_URL = `${BASE_URL}/upload`;

        const WORDCLOUD_PALETTE = ["#2563eb", "#10b981", "#f97316", "#a855f7", "#ec4899", "#0ea5e9", "#fbbf24", "#14b8a6", "#94a3b8"];
        const C_POS = "#39ff14"; const C_NEU = "#8c93a8"; const C_NEG = "#ef4444"; 

        document.addEventListener('DOMContentLoaded', () => {
            const analyzeBtn = document.getElementById('btnAnalyze');
            const clearBtn = document.getElementById('btnClear');
            const textArea = document.getElementById('reviewInput');
            const resultGrid = document.querySelector('.result-grid');
            const fileInput = document.getElementById('fileInput');
            const uploadZone = document.getElementById('uploadSection');
            const textSection = document.getElementById('textSection');
            const tabs = document.querySelectorAll('.tab-btn');
            const fileInfo = document.getElementById('fileInfo');
            const fileNameSpan = document.getElementById('fileName');

            let currentMode = 'text'; 
            let selectedFile = null;

            // --- TAB SWITCH ---
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentMode = tab.dataset.tab;
                    textSection.style.display = currentMode === 'text' ? 'block' : 'none';
                    uploadZone.style.display = currentMode === 'file' ? 'block' : 'none';
                    if(currentMode === 'file') setTimeout(() => uploadZone.classList.add('active'), 10);
                    resultGrid.style.display = 'none';
                });
            });

            // --- UPLOAD HANDLERS ---
            uploadZone.addEventListener('click', () => fileInput.click());
            uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.style.background = '#eff6ff'; });
            uploadZone.addEventListener('drop', (e) => { 
                e.preventDefault(); 
                if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); 
            });
            fileInput.addEventListener('change', (e) => { 
                if (e.target.files.length) handleFile(e.target.files[0]); 
            });

            function handleFile(file) {
                selectedFile = file;
                fileNameSpan.textContent = file.name;
                fileInfo.style.display = 'block';
                // Reset value to allow re-selecting same file if needed
                fileInput.value = ''; 
            }

            // --- ANALYZE LOGIC ---
            analyzeBtn.addEventListener('click', async () => {
                setLoading(true);
                try {
                    let dataToRender = [];

                    if (currentMode === 'text') {
                        const text = textArea.value.trim();
                        if (!text) throw new Error("Please enter a review!");

                        console.log('Sending request to:', ANALYZE_URL);
                        const response = await fetch(ANALYZE_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: text })
                        }).catch(err => {
                            console.error('Fetch error:', err);
                            throw new Error(`Network error: ${err.message}. Make sure API is running at http://localhost:8000`);
                        });
                        
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Error response:', errorText);
                            throw new Error(`Server Error: ${response.status} ${response.statusText}`);
                        }
                        dataToRender = await response.json();
                    
                    } else {
                        if (!selectedFile) throw new Error("Please select a file first!");

                        const formData = new FormData();
                        // QUAN TR·ªåNG: T√™n bi·∫øn 'file' ph·∫£i kh·ªõp v·ªõi backend Python (def upload(file: ...))
                        formData.append("file", selectedFile); 

                        console.log('Uploading file to:', UPLOAD_URL);
                        const response = await fetch(UPLOAD_URL, {
                            method: 'POST',
                            body: formData // Browser t·ª± ƒë·ªông set Content-Type multipart/form-data
                        }).catch(err => {
                            console.error('Upload error:', err);
                            throw new Error(`Network error: ${err.message}. Make sure API is running at http://localhost:8000`);
                        });

                        if (!response.ok) {
                            const errText = await response.text();
                            throw new Error(`Upload Failed (${response.status}): ${errText}`);
                        }

                        const jsonResponse = await response.json();
                        console.log("Upload Response:", jsonResponse); // Debug logs

                        // FLATTEN DATA: X·ª≠ l√Ω c·∫£ Aspects (Hoa) v√† aspects (Th∆∞·ªùng)
                        if (jsonResponse.results) {
                            jsonResponse.results.forEach(review => {
                                // Ki·ªÉm tra c√°c key c√≥ th·ªÉ c√≥
                                const aspects = review.Aspects || review.aspects || [];
                                if (Array.isArray(aspects)) {
                                    dataToRender = dataToRender.concat(aspects);
                                }
                            });
                        }
                    }

                    if (dataToRender.length === 0) {
                        alert("No aspects detected. Check if your file has a 'Review' column and valid data.");
                        setLoading(false);
                        return;
                    }

                    resultGrid.style.display = 'grid'; 
                    processAndRenderData(dataToRender);
                    resultGrid.scrollIntoView({ behavior: 'smooth' });

                } catch (error) {
                    console.error(error);
                    alert("‚ö†Ô∏è ERROR: " + error.message + "\n\nTip: Open Console (F12) for details.");
                } finally {
                    setLoading(false);
                }
            });

            function setLoading(isLoading) {
                analyzeBtn.textContent = isLoading ? "Analyzing..." : "Analyze Insights";
                analyzeBtn.disabled = isLoading;
            }

            // --- VISUALIZATION (GI·ªÆ NGUY√äN LOGIC C≈®) ---
            function processAndRenderData(data) {
                let totalScore = 0, count = 0;
                const polarityCounts = { 'Positive': 0, 'Neutral': 0, 'Negative': 0 };

                data.forEach(item => {
                    if (item['Category Score']) { totalScore += item['Category Score']; count++; }
                    const pol = item['Polarity'];
                    if (polarityCounts.hasOwnProperty(pol)) polarityCounts[pol]++;
                });

                const avgScore = count > 0 ? (totalScore / count * 10).toFixed(2) : "0.00";
                let dominant = "Neutral", maxVal = -1;
                for (const [key, val] of Object.entries(polarityCounts)) {
                    if (val > maxVal) { maxVal = val; dominant = key; }
                }

                document.querySelector('.score-big').textContent = `${avgScore}/10`;
                document.getElementById('dominantText').textContent = dominant;

                renderCategoryChart(data);
                renderPolarityChart(polarityCounts, data.length);
                renderStatsTable(data);
                renderDetailedTable(data);
                setTimeout(() => renderWordClouds(data), 100);
            }

            function renderCategoryChart(data) {
                const catGroups = {};
                data.forEach(item => {
                    const cat = item['Category'];
                    const score = item['Category Score'] || 0;
                    if (!catGroups[cat]) catGroups[cat] = { total: 0, count: 0 };
                    catGroups[cat].total += score; catGroups[cat].count += 1;
                });
                let html = '';
                for (const [cat, val] of Object.entries(catGroups)) {
                    const avg = (val.total / val.count).toFixed(2);
                    html += `<div class="bar-chart-row"><div class="bar-label">${cat}</div><div class="bar-track"><div class="bar-fill" style="width: ${Math.min(avg * 100, 100)}%;"></div></div><div class="bar-value">${avg}</div></div>`;
                }
                document.querySelector('.chart-container-bar').innerHTML = html;
            }

            function renderPolarityChart(counts, total) {
                if (total === 0) return;
                const pos = (counts['Positive'] / total) * 100;
                const neu = (counts['Neutral'] / total) * 100;
                const donut = document.querySelector('.donut');
                donut.style.background = `conic-gradient(${C_POS} 0% ${pos}%, ${C_NEU} ${pos}% ${pos + neu}%, ${C_NEG} ${pos + neu}% 100%)`;
                
                const maxVal = Math.max(counts['Positive'], counts['Neutral'], counts['Negative']);
                let label = "Neutral", color = C_NEU;
                if (maxVal === counts['Positive']) { label = "Positive"; color = C_POS; }
                else if (maxVal === counts['Negative']) { label = "Negative"; color = C_NEG; }
                document.querySelector('.donut-hole span:first-child').textContent = `${Math.round(maxVal/total*100)}%`;
                document.querySelector('.donut-hole span:first-child').style.color = color;
            }

            function renderStatsTable(data) {
                const stats = {};
                let gTotal=0, gPos=0, gNeu=0, gNeg=0, gScore=0; 
                data.forEach(item => {
                    const cat = item['Category'];
                    if (!stats[cat]) stats[cat] = { total: 0, pos: 0, neu: 0, neg: 0, scoreSum: 0 }; 
                    stats[cat].total++;
                    if (item.Polarity === 'Positive') stats[cat].pos++;
                    else if (item.Polarity === 'Neutral') stats[cat].neu++;
                    else if (item.Polarity === 'Negative') stats[cat].neg++;
                    stats[cat].scoreSum += (item['Category Score'] || 0);
                });
                let rows = '';
                for (const [cat, val] of Object.entries(stats)) {
                    const avg = (val.scoreSum / val.total).toFixed(2);
                    gTotal+=val.total; gPos+=val.pos; gNeu+=val.neu; gNeg+=val.neg; gScore+=val.scoreSum;
                    rows += `<tr><td>${cat}</td><td>${val.total}</td><td>${val.pos}</td><td>${val.neu}</td><td>${val.neg}</td><td>${avg}</td></tr>`;
                }
                const gAvg = gTotal > 0 ? (gScore/gTotal).toFixed(2) : "0.00";
                rows += `<tr style="font-weight: bold; background: #f8fafc;"><td>üìä TOTAL</td><td>${gTotal}</td><td>${gPos}</td><td>${gNeu}</td><td>${gNeg}</td><td>${gAvg}</td></tr>`;
                document.querySelector('#statsTable tbody').innerHTML = rows;
            }

            function renderDetailedTable(data) {
                let rows = '';
                (data.length > 500 ? data.slice(0, 500) : data).forEach(item => {
                    const polColor = item.Polarity === 'Positive' ? C_POS : (item.Polarity === 'Negative' ? C_NEG : C_NEU);
                    const categoryScore = (item['Category Score'] || 0).toFixed(2);
                    const polarityScore = (item['Polarity Score'] || 0).toFixed(2);
                    rows += `<tr><td>${item.Clause}</td><td>${item.Term || '-'}</td><td>${item.Opinion || '-'}</td><td>${item.Category || '-'}</td><td>${categoryScore}</td><td style="color:${polColor}">${item.Polarity}</td><td>${polarityScore}</td><td style="font-size:12px;color:#475569">${item['Original Sentence'] || item['sentence_original'] || '-'}</td></tr>`;
                });
                document.querySelector('#detailedTable tbody').innerHTML = rows;
            }

            function renderWordClouds(data) {
                // TERMS: T√°ch t·ª´ng t·ª´ ƒë∆°n
                const terms = data.map(i => i.Term).filter(i => i).join(" ");
                drawCanvasWords('termCanvas', terms, 1.2);
                
                // OPINIONS: Gi·ªØ nguy√™n c·ª•m t·ª´ ho√†n ch·ªânh
                const opinions = data.map(i => i.Opinion).filter(i => i && i.trim().length > 0);
                drawCanvasPhrases('opinionCanvas', opinions, 1.0);
            }

            // V·∫Ω wordcloud cho TERMS (t√°ch t·ª´ng t·ª´)
            function drawCanvasWords(canvasId, textString, weightFactor) {
                const canvas = document.getElementById(canvasId);
                const parent = canvas.parentElement;
                canvas.width = parent.offsetWidth; 
                canvas.height = parent.offsetHeight;
                
                const words = textString.split(/[\s,]+/).map(w => w.trim().toLowerCase()).filter(w => w.length > 1);
                const freqMap = {}; 
                words.forEach(w => freqMap[w] = (freqMap[w] || 0) + 1);
                let list = Object.entries(freqMap).sort((a, b) => b[1] - a[1]);
                if (list.length === 0) return;
                
                list = list.slice(0, 40);
                
                const count = list.length;
                let dynamicScale = count < 5 ? 6.0 : (count < 10 ? 4.5 : (count < 20 ? 3.0 : (count < 40 ? 1.8 : 1.2)));
                const gridSize = Math.round(6 * canvas.width / 1024); 

                WordCloud(canvas, {
                    list: list, 
                    gridSize: gridSize, 
                    weightFactor: function (size) { 
                        return Math.pow(size, 0.9) * 28 * weightFactor * dynamicScale * (canvas.width / 800); 
                    },
                    fontFamily: 'Plus Jakarta Sans, sans-serif', 
                    fontWeight: '800',
                    color: () => WORDCLOUD_PALETTE[Math.floor(Math.random() * WORDCLOUD_PALETTE.length)],
                    backgroundColor: 'transparent', 
                    shrinkToFit: true, 
                    origin: [canvas.width / 2, canvas.height / 2],
                    rotateRatio: 0,
                    minRotation: 0,
                    maxRotation: 0,
                    drawOutOfBound: false,
                    shuffle: false
                });
            }

            // V·∫Ω wordcloud cho OPINIONS (gi·ªØ nguy√™n c·ª•m t·ª´)
            function drawCanvasPhrases(canvasId, phrasesArray, weightFactor) {
                const canvas = document.getElementById(canvasId);
                const parent = canvas.parentElement;
                canvas.width = parent.offsetWidth; 
                canvas.height = parent.offsetHeight;
                
                // ƒê·∫øm t·∫ßn su·∫•t xu·∫•t hi·ªán c·ªßa t·ª´ng C·ª§M T·ª™
                const freqMap = {}; 
                phrasesArray.forEach(phrase => {
                    // Lo·∫°i b·ªè d·∫•u ph·∫©y v√† c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát, ch·ªâ gi·ªØ ch·ªØ, s·ªë, g·∫°ch n·ªëi v√† kho·∫£ng tr·∫Øng
                    const normalized = phrase.trim()
                        .toLowerCase()
                        .replace(/[,;:.!?()]/g, '') // X√≥a d·∫•u c√¢u
                        .replace(/\s+/g, ' ')       // Chu·∫©n h√≥a kho·∫£ng tr·∫Øng
                        .trim();
                    
                    if (normalized.length > 0) {
                        freqMap[normalized] = (freqMap[normalized] || 0) + 1;
                    }
                });
                
                let list = Object.entries(freqMap).sort((a, b) => b[1] - a[1]);
                if (list.length === 0) return;
                
                list = list.slice(0, 30); // Gi·ªõi h·∫°n 30 c·ª•m t·ª´ ph·ªï bi·∫øn nh·∫•t
                
                const count = list.length;
                let dynamicScale = count < 5 ? 5.0 : (count < 10 ? 3.8 : (count < 20 ? 2.5 : 1.5));
                const gridSize = Math.round(8 * canvas.width / 1024); // TƒÉng gridSize cho c·ª•m t·ª´ d√†i

                WordCloud(canvas, {
                    list: list, 
                    gridSize: gridSize, 
                    weightFactor: function (size) { 
                        return Math.pow(size, 0.85) * 22 * weightFactor * dynamicScale * (canvas.width / 800); 
                    },
                    fontFamily: 'Plus Jakarta Sans, sans-serif', 
                    fontWeight: '800',
                    color: () => WORDCLOUD_PALETTE[Math.floor(Math.random() * WORDCLOUD_PALETTE.length)],
                    backgroundColor: 'transparent', 
                    shrinkToFit: true,
                    origin: [canvas.width / 2, canvas.height / 2],
                    rotateRatio: 0,
                    minRotation: 0,
                    maxRotation: 0,
                    drawOutOfBound: false,
                    shuffle: false
                });
            }
        });
    </script>
</body>
</html>